---
import Layout from './Layout.astro';
import TileNavigation from '../components/TileNavigation.astro';
import TileList from '../components/TileList.astro';
import { BreadcrumbNav, BreadcrumbNavLink, BreadcrumbNavSeparator } from '@utrecht/component-library-react';
import { base } from 'astro:config/client';
import { joinUrl } from '../utils/url';

interface Props {
  page: {
    id: string;
    data: {
      title: string;
      description: string;
      icon?: string;
    };
  };
  childPages: Array<{
    id: string;
    data: {
      title: string;
      description: string;
      icon?: string;
      thumbnail?: string;
    };
  }>;
  allPages: Array<{
    id: string;
    data: {
      title: string;
    };
  }>;
}

const { page, childPages, allPages } = Astro.props;

function generateBreadcrumbs(pageId: string, pages: any[]) {
  // Remove _index suffix to get the actual path
  const slug = pageId.replace(/\/_index$/, '').replace(/^_index$/, '');
  const parts = slug ? slug.split('/') : [];
  const breadcrumbs: Array<{ label: string; href: string }> = [];

  breadcrumbs.push({ label: 'Home', href: joinUrl(base, '/') });

  let currentPath = '';
  for (let i = 0; i < parts.length; i++) {
    currentPath += (currentPath ? '/' : '') + parts[i];

    const indexPage = pages.find(p => p.id === `${currentPath}/_index`);
    const label = indexPage?.data?.title || parts[i]
      .split('-')
      .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');

    breadcrumbs.push({ label, href: joinUrl(base, `/${currentPath}`) });
  }

  return breadcrumbs;
}

const breadcrumbs = generateBreadcrumbs(page.id, allPages);

const tiles = childPages.map((child) => {
  let href = joinUrl(base, `/${child.id}`);

  return {
    title: child.data.title,
    description: child.data.description || '',
    href,
    icon: child.data.icon,
    thumbnail: child.data.thumbnail,
  };
});
---

<Layout>
  <article class="navigation-page">
    {breadcrumbs.length > 1 && (
      <BreadcrumbNav>
        {breadcrumbs.map((crumb, index) => (
          <>
            {index > 0 && <BreadcrumbNavSeparator><utrecht-icon-chevron-right /></BreadcrumbNavSeparator>}
            <BreadcrumbNavLink
              href={crumb.href}
              index={index}
              current={index === breadcrumbs.length - 1}
            >
              {crumb.label}
            </BreadcrumbNavLink>
          </>
        ))}
      </BreadcrumbNav>
    )}

    <div class="navigation-page__content">
      <slot />
    </div>

    {tiles.length > 0 && (
      <TileList>
        {tiles.map((tile) => (
          <TileNavigation href={tile.href} title={tile.title} description={tile.description} />
        ))}
      </TileList>
    )}
  </article>
</Layout>

<style>
  .navigation-page {
    padding-block-start: 2rem;
  }

  .navigation-page__content {
    margin-block-end: 2rem;
  }
</style>
